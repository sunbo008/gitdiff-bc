# 设计文档：终端 Git 文件比较

## Context

用户在开发过程中经常需要：
1. 在终端运行 `git status` 查看修改的文件
2. 切换到资源管理器找到对应文件
3. 右键选择比较命令

此流程需要频繁在终端和资源管理器之间切换，降低了开发效率。

### 约束条件
- VSCode 终端 API 限制：无法直接在文本上添加右键菜单项
- 终端右键菜单是全局的，需要通过 `when` 条件动态控制显示
- 终端输出的文件路径格式多样（相对路径、带前缀、带缩进等）
- 需要验证路径有效性且在 Git 仓库中

## Goals / Non-Goals

### Goals
- 用户能在终端右键点击文件路径，直接比较文件与 Git HEAD
- **用户能在终端选中多行文本，批量比较所有文件与 Git HEAD**
- 支持 `git status` 输出的所有常见路径格式
- 菜单项仅在有效文件路径时显示，保持菜单简洁
- 保持与资源管理器中比较功能的一致性（命令名称、行为、错误提示）
- 批量比较时提供清晰的进度反馈和操作摘要

### Non-Goals
- 不支持文件夹比较（终端场景主要是文件比较）
- 不支持两个文件相互比较（终端场景下与 Git HEAD 比较更常见）
- 不支持其他 Git 命令输出（如 `git diff --stat`，范围过广）
- 不支持并行比较（Beyond Compare 窗口按顺序打开，避免资源占用过高）

## Decisions

### 决策 1：路径检测策略（支持单文件和多文件）

**修正方案：自动复制选区（Auto-Copy Workaround）**

由于 VSCode 扩展 API `window.activeTerminal` 不支持直接读取选中文本或光标位置，我们采用以下 Workaround：

1. **用户操作**：选中终端中的文件路径（单行或多行）
2. **触发命令**：右键点击 "与 Git HEAD 比较文件"
3. **扩展行为**：
   - 调用 `workbench.action.terminal.copySelection` 自动将选区复制到剪贴板
   - 等待剪贴板更新（100-200ms）
   - 读取剪贴板内容
   - 如果剪贴板内容有效，执行比较
   - 如果无效（未选中），回退到输入框让用户手动粘贴

**实现**：
```typescript
// 自动复制选区
await vscode.commands.executeCommand('workbench.action.terminal.copySelection');
// 读取剪贴板
const text = await vscode.env.clipboard.readText();
// 执行比较...
```

### 决策 2：路径解析规则

支持以下格式（按优先级）：
```
1. modified:   platform/mac/App.mm          # git status 标准格式
2. new file:   src/utils/parser.ts          # 新文件格式
3. deleted:    old/file.ts                  # 删除文件（可选支持）
4.     platform/mac/App.mm                  # 带缩进的纯路径
5. platform/mac/App.mm                      # 纯路径
```

解析流程：
1. 去除行首空白和 git status 前缀（modified:, new file: 等）
2. 提取文件路径（去除尾部空白和注释）
3. 拼接工作区根路径，生成绝对路径
4. 验证文件存在且在 Git 仓库中

### 决策 3：菜单显示逻辑

**静态菜单 + 底部显示**

由于终端右键菜单不支持动态 `when` 条件（无法根据选中文本动态显示），采用以下策略：

- **始终显示**：只要在终端中，菜单项始终可见
- **位置优化**：将 `group` 设置为 `z_commands`，确保显示在右键菜单的最底部，避免干扰常用操作（如复制/粘贴）
- **名称统一**：使用 "与 Git HEAD 比较文件" 作为通用入口

### 决策 4：与现有功能的集成

复用现有 `compareFileWithHead` 函数：
- 修改函数签名，支持可选参数：`compareFileWithHead(uri?: vscode.Uri, filePath?: string)`
- 当 `filePath` 提供时，从路径字符串构造 Uri
- 保持现有资源管理器调用方式不变

### 决策 5：多工作区处理

当有多个工作区时：
1. 尝试从当前终端的 cwd 确定所属工作区
2. 如果无法确定，使用第一个工作区
3. 在所有工作区中搜索匹配的文件路径

## Risks / Trade-offs

### 风险 1：路径解析不准确
- **风险**：用户右键点击的位置不包含完整文件路径，或包含多个路径
- **缓解**：提供清晰的错误提示，引导用户检查路径

### 风险 2：性能影响
- **风险**：频繁的路径验证（文件系统访问、Git 检查）可能影响性能
- **缓解**：仅在用户点击菜单时执行验证，不进行实时监听

### 风险 3：用户体验不一致
- **风险**：终端右键行为与资源管理器不同，可能造成困惑
- **缓解**：使用相同的命令名称、提示消息和错误处理逻辑

### 风险 4：批量比较窗口过多
- **风险**：用户选中大量文件（如 50+ 个），导致 Beyond Compare 窗口过多，系统卡顿
- **缓解方案**：
  - 设置最大批量数量限制（如 20 个文件）
  - 超过限制时提示用户："选中了 {n} 个文件，是否继续？（建议分批比较）"
  - 提供取消选项，允许用户中断批量比较

### 风险 5：终端 API 限制
- **风险**：VSCode 终端 API 可能无法直接读取选中文本或光标位置
- **缓解**：
  - 优先使用 `vscode.window.activeTerminal` 的标准 API
  - 如果 API 不支持，使用替代方案（如剪贴板读取选中文本）
  - 最坏情况：提示用户手动复制文件路径，通过命令面板输入

## Migration Plan

无需迁移。新功能向后兼容，不影响现有功能。

## Open Questions

1. ~~是否需要支持删除的文件比较？~~（暂不支持，deleted 文件无法比较工作区版本）
2. ~~如何处理文件路径包含空格的情况？~~（路径解析正则需要支持空格）
3. ~~是否需要提供配置项禁用此功能？~~（暂不需要，功能足够轻量）
4. ~~批量比较的最大文件数量限制？~~（建议 20 个，超过时提示确认）
5. ~~批量比较是否需要支持并行？~~（否，顺序打开 Beyond Compare 窗口，避免资源占用）
6. **VSCode 终端 API 是否支持读取选中文本？** - 需要在实现时验证，可能需要 workaround

