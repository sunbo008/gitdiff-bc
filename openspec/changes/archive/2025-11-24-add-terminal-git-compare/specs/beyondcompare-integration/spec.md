## ADDED Requirements

### Requirement: 终端文件路径比较

扩展 SHALL 支持在终端右键菜单中比较 `git status` 输出的文件与 Git HEAD，支持单个文件和批量多个文件比较。

#### Scenario: 在 git status 输出中右键比较文件

- **WHEN** 用户在终端运行 `git status` 命令
- **AND** 用户**选中**了包含文件路径的文本（如 `platform/mac/App.mm`）
- **AND** 用户右键选择"与 Git HEAD 比较文件"命令
- **THEN** 扩展应**自动执行复制操作**获取选中文本
- **AND** 解析文本中的文件路径
- **AND** 验证文件存在且在 Git 仓库中
- **AND** 使用 Beyond Compare 比较该文件与 Git HEAD

#### Scenario: 未选中文本时的处理

- **WHEN** 用户右键点击但未选中文本
- **AND** 自动复制操作未获取到有效路径
- **THEN** 扩展应显示输入框："未能自动获取选中文本，请粘贴要比较的文件路径"
- **AND** 允许用户手动输入或粘贴路径
- **AND** 验证并执行比较

#### Scenario: 路径解析支持多种格式

- **WHEN** 终端输出包含不同格式的文件路径
- **THEN** 扩展应正确解析以下格式：
  - `modified:   path/to/file.ts` - 带 git status 前缀
  - `new file:   path/to/file.ts` - 新文件格式
  - `    path/to/file.ts` - 带缩进的路径
  - `path/to/file.ts` - 纯路径
  - `path/to/file with spaces.ts` - 包含空格的路径
- **AND** 去除前导/尾随空白和 git 状态前缀
- **AND** 提取出完整的相对文件路径

#### Scenario: 右键点击非文件路径时不显示菜单

- **WHEN** 用户在终端中右键点击，但光标所在行不包含有效的文件路径
- **OR** 解析出的路径不是工作区中的文件
- **OR** 文件不在 Git 仓库中
- **THEN** "与 Git HEAD 比较文件"菜单项不应显示
- **OR** 点击后显示提示："未检测到有效的文件路径"

#### Scenario: 多工作区环境中的路径解析

- **WHEN** 用户有多个工作区文件夹
- **AND** 在终端中右键点击文件路径
- **THEN** 扩展应尝试从终端的当前工作目录确定所属工作区
- **AND** 如果无法确定，应在所有工作区中搜索匹配的文件
- **AND** 如果找到多个匹配，使用第一个匹配的文件
- **AND** 如果未找到匹配，显示错误："文件不在工作区中"

#### Scenario: 支持相对路径和绝对路径

- **WHEN** 终端输出包含相对路径（相对于 Git 仓库根目录）
- **THEN** 扩展应将其转换为绝对路径进行验证和比较
- **WHEN** 终端输出包含绝对路径
- **THEN** 扩展应直接使用该路径，验证其在工作区中

#### Scenario: 错误处理与用户提示

- **WHEN** 解析出的文件路径不存在
- **THEN** 扩展应显示错误："文件不存在: {path}"
- **WHEN** 文件存在但不在 Git 仓库中
- **THEN** 扩展应显示错误："文件不在 Git 版本控制中"
- **WHEN** Git 仓库不存在或损坏
- **THEN** 扩展应显示错误："当前目录不是 Git 仓库"
- **AND** 错误提示应与资源管理器中的文件比较错误提示保持一致

### Requirement: 终端批量文件比较

扩展 SHALL 支持在终端中选中多行文本，批量比较所有有效文件与 Git HEAD。

#### Scenario: 选中多个文件路径并批量比较

- **WHEN** 用户在终端中选中多行文本（如 git status 输出的多个文件）
- **AND** 选中的文本包含多个有效的文件路径
- **AND** 用户右键选择"与 Git HEAD 比较文件"命令
- **THEN** 扩展应检测到有选中文本
- **AND** 解析选中文本中的所有文件路径（逐行提取）
- **AND** 过滤出所有存在且在 Git 仓库中的有效文件
- **AND** 依次对每个有效文件启动 Beyond Compare 进行比较
- **AND** 显示进度提示："正在比较第 {current}/{total} 个文件: {filename}"
- **AND** 完成后显示摘要："成功比较 {success} 个文件"

#### Scenario: 批量比较中包含部分无效路径

- **WHEN** 选中的文本包含一些有效路径和一些无效路径
- **OR** 某些行不包含文件路径（如空行、注释行）
- **THEN** 扩展应仅比较有效的文件
- **AND** 跳过无效路径，不显示错误（避免打断流程）
- **AND** 在日志中记录："跳过无效路径: {invalidPath}"
- **AND** 完成后显示摘要："成功比较 {success} 个文件，跳过 {skipped} 个无效路径"

#### Scenario: 批量比较文件数量限制

- **WHEN** 用户选中的文本包含超过 20 个有效文件路径
- **THEN** 扩展应显示确认对话框："检测到 {count} 个文件，是否继续批量比较？这可能会打开多个 Beyond Compare 窗口"
- **AND** 提供"继续"和"取消"选项
- **WHEN** 用户选择"取消"
- **THEN** 扩展应中止操作，不启动任何比较
- **WHEN** 用户选择"继续"
- **THEN** 扩展应继续执行批量比较

#### Scenario: 用户取消批量比较进度

- **WHEN** 批量比较正在进行中（如正在比较第 5/20 个文件）
- **AND** 进度提示显示"取消"按钮
- **AND** 用户点击"取消"按钮
- **THEN** 扩展应停止后续文件的比较
- **AND** 已启动的 Beyond Compare 窗口保持打开（不关闭已打开的窗口）
- **AND** 显示提示："已取消，已比较 {completed} 个文件"

#### Scenario: 批量比较与单文件比较的切换

- **WHEN** 用户在终端右键点击，且有文本被选中
- **THEN** 命令自动进入批量比较模式
- **WHEN** 用户在终端右键点击，且没有文本被选中
- **THEN** 命令自动进入单文件比较模式（解析光标所在行）
- **AND** 两种模式使用相同的菜单项"与 Git HEAD 比较文件"
- **AND** 用户无需手动选择模式

#### Scenario: 批量比较的顺序执行

- **WHEN** 批量比较多个文件
- **THEN** 扩展应按照文件在选中文本中的顺序依次启动 Beyond Compare
- **AND** 不应并行启动多个 Beyond Compare 进程（避免资源占用过高）
- **AND** 等待上一个 Beyond Compare 启动完成后，再启动下一个
- **AND** 超时时间设置为 2 秒（避免无限等待）

### Requirement: 终端右键菜单集成

扩展 SHALL 在 VSCode 终端的右键菜单中注册文件比较命令，并优化显示位置。

#### Scenario: 菜单项显示位置

- **WHEN** 用户在 VSCode 终端中右键点击
- **THEN** 右键菜单应包含"与 Git HEAD 比较文件"选项
- **AND** 该选项应显示在菜单的最底部（`z_commands` 分组）
- **AND** 避免干扰常用的复制/粘贴操作

#### Scenario: 终端获得焦点时显示菜单项

- **WHEN** 用户在 VSCode 终端中右键点击

- **WHEN** 用户在 VSCode 终端中右键点击
- **THEN** 右键菜单应包含"与 Git HEAD 比较文件"选项
- **AND** 该选项应位于合理的菜单分组中
- **AND** 命令名称应与资源管理器中的文件比较命令完全一致

#### Scenario: 非终端环境不显示菜单项

- **WHEN** 用户在编辑器、资源管理器或其他非终端面板中右键点击
- **THEN** "与 Git HEAD 比较文件"选项不应在这些位置的右键菜单中显示（避免重复）

#### Scenario: 命令执行反馈

- **WHEN** 用户从终端右键菜单选择比较命令
- **THEN** 扩展应显示进度提示："正在解析文件路径..."
- **AND** 解析完成后显示："正在启动 Beyond Compare..."
- **AND** 成功启动后，进度提示自动消失
- **AND** 失败时显示清晰的错误消息

### Requirement: 终端路径解析器

扩展 SHALL 提供专用的终端路径解析工具，从终端文本中提取文件路径。

#### Scenario: 从终端行提取文件路径

- **WHEN** 给定终端的一行文本
- **THEN** 解析器应识别并提取文件路径
- **AND** 支持常见的文件路径模式：
  - Unix 风格：`path/to/file.ext`
  - Windows 风格：`path\to\file.ext` 或 `C:\path\to\file.ext`
  - 混合风格：`C:/path/to/file.ext`
- **AND** 忽略非路径内容（行号、git 状态提示等）

#### Scenario: 清理路径前缀和后缀

- **WHEN** 文件路径带有 git status 前缀（如 `modified:   `）
- **THEN** 解析器应去除这些前缀，仅保留文件路径
- **WHEN** 文件路径前后有空白字符或制表符
- **THEN** 解析器应去除这些空白，仅保留干净的路径
- **WHEN** 行中包含注释或其他后缀内容
- **THEN** 解析器应仅提取文件路径部分

#### Scenario: 路径验证

- **WHEN** 解析出候选文件路径
- **THEN** 解析器应验证该路径是否指向存在的文件
- **AND** 验证该文件是否在当前工作区中
- **AND** 验证该文件是否在 Git 仓库中
- **AND** 如果任一验证失败，返回 null 或错误

#### Scenario: 支持工作区相对路径

- **WHEN** 解析出的路径是相对路径
- **THEN** 解析器应尝试相对于以下基准路径解析：
  1. 终端当前工作目录（如果可获取）
  2. 第一个工作区根目录
  3. Git 仓库根目录
- **AND** 返回第一个找到的有效文件的绝对路径

### Requirement: 终端比较国际化支持

扩展的终端文件比较功能 SHALL 支持中英文国际化。

#### Scenario: 命令名称国际化

- **WHEN** VSCode 显示语言为英文
- **THEN** 终端右键菜单应显示 "Compare File with Git HEAD"
- **WHEN** VSCode 显示语言为简体中文
- **THEN** 终端右键菜单应显示 "与 Git HEAD 比较文件"
- **AND** 命令名称应复用现有的国际化键值

#### Scenario: 错误提示国际化

- **WHEN** 终端路径解析失败或文件比较失败
- **THEN** 错误消息应根据当前语言显示
- **AND** 复用现有的错误提示国际化文本
- **AND** 例如：中文 "未检测到有效的文件路径"，英文 "No valid file path detected"

#### Scenario: 进度提示国际化

- **WHEN** 显示操作进度提示
- **THEN** 提示消息应根据当前语言显示
- **AND** 例如：中文 "正在解析文件路径..."，英文 "Parsing file path..."

